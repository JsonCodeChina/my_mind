#!/usr/bin/env python3
"""
é‚®ä»¶å‘é€å·¥å…·

åŠŸèƒ½ï¼š
1. è¯»å– Markdown æŠ¥å‘Šå¹¶è½¬æ¢ä¸º HTML
2. å‘é€é‚®ä»¶åˆ°é…ç½®çš„æ”¶ä»¶äºº
3. æ”¯æŒ TLS/SSL åŠ å¯†
4. æ”¯æŒé™„ä»¶

ä½¿ç”¨ï¼š
    python email_sender.py --report cc/2025-10-28/index.md --type ccnews
    python email_sender.py --report ainews/2025-10-28/index.md --type ainews
"""

import argparse
import logging
import os
import smtplib
import sys
from datetime import datetime
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.base import MIMEBase
from email import encoders
from pathlib import Path

try:
    import yaml
    import markdown
except ImportError as e:
    print(f"é”™è¯¯: ç¼ºå°‘ä¾èµ–åº“ - {e}")
    print("è¯·è¿è¡Œ: pip install pyyaml markdown")
    sys.exit(1)

# ============================================================================
# æ—¥å¿—é…ç½®
# ============================================================================

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    datefmt='%H:%M:%S'
)
logger = logging.getLogger(__name__)


# ============================================================================
# é…ç½®åŠ è½½
# ============================================================================

def load_config(config_path: str = None) -> dict:
    """åŠ è½½é…ç½®æ–‡ä»¶"""
    if config_path is None:
        script_dir = Path(__file__).parent
        config_path = script_dir / "config.yaml"

    with open(config_path, 'r', encoding='utf-8') as f:
        return yaml.safe_load(f)


# ============================================================================
# Markdown è½¬ HTML
# ============================================================================

def markdown_to_html(md_content: str, title: str = "AI Report") -> str:
    """å°† Markdown è½¬æ¢ä¸ºç¾åŒ–çš„ HTML"""

    # è½¬æ¢ Markdown
    html_body = markdown.markdown(
        md_content,
        extensions=['extra', 'codehilite', 'tables', 'fenced_code']
    )

    # æ·»åŠ æ ·å¼
    html_template = f"""
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{title}</title>
    <style>
        body {{
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #24292e;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f6f8fa;
        }}
        .container {{
            background-color: white;
            padding: 40px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }}
        h1 {{
            color: #1a73e8;
            border-bottom: 2px solid #1a73e8;
            padding-bottom: 10px;
        }}
        h2 {{
            color: #2c5aa0;
            margin-top: 30px;
            border-left: 4px solid #1a73e8;
            padding-left: 15px;
        }}
        h3 {{
            color: #444;
            margin-top: 20px;
        }}
        code {{
            background-color: #f6f8fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 85%;
        }}
        pre {{
            background-color: #f6f8fa;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
        }}
        blockquote {{
            border-left: 4px solid #dfe2e5;
            padding-left: 16px;
            color: #6a737d;
            margin: 16px 0;
        }}
        table {{
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }}
        th, td {{
            border: 1px solid #dfe2e5;
            padding: 12px;
            text-align: left;
        }}
        th {{
            background-color: #f6f8fa;
            font-weight: 600;
        }}
        a {{
            color: #1a73e8;
            text-decoration: none;
        }}
        a:hover {{
            text-decoration: underline;
        }}
        .footer {{
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e1e4e8;
            color: #6a737d;
            font-size: 14px;
            text-align: center;
        }}
        .emoji {{
            font-size: 1.2em;
        }}
        hr {{
            border: none;
            border-top: 1px solid #e1e4e8;
            margin: 24px 0;
        }}
    </style>
</head>
<body>
    <div class="container">
        {html_body}
        <div class="footer">
            <p>ğŸ“Š Generated by Mind AI Tracking System</p>
            <p>Powered by Claude Code | {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
        </div>
    </div>
</body>
</html>
"""
    return html_template


# ============================================================================
# é‚®ä»¶å‘é€
# ============================================================================

class EmailSender:
    """é‚®ä»¶å‘é€å™¨"""

    def __init__(self, config: dict):
        self.config = config['email']
        self.smtp_config = self.config['smtp']
        self.sender_config = self.config['sender']

        # ä»ç¯å¢ƒå˜é‡è¯»å–å¯†ç ï¼ˆä¼˜å…ˆçº§é«˜äºé…ç½®æ–‡ä»¶ï¼‰
        self.password = os.getenv('MIND_EMAIL_PASSWORD', self.sender_config.get('password', ''))

    def send_report(self, report_path: str, report_type: str = "ccnews") -> bool:
        """å‘é€æŠ¥å‘Šé‚®ä»¶"""

        if not self.config.get('enabled', False):
            logger.warning("é‚®ä»¶æ¨é€æœªå¯ç”¨ï¼Œè¯·åœ¨ config.yaml ä¸­è®¾ç½® email.enabled: true")
            return False

        if not self.password:
            logger.error("æœªè®¾ç½®é‚®ç®±å¯†ç ï¼Œè¯·é…ç½®ç¯å¢ƒå˜é‡ MIND_EMAIL_PASSWORD æˆ–åœ¨ config.yaml ä¸­è®¾ç½®")
            return False

        # è¯»å–æŠ¥å‘Šå†…å®¹
        try:
            with open(report_path, 'r', encoding='utf-8') as f:
                md_content = f.read()
        except FileNotFoundError:
            logger.error(f"æŠ¥å‘Šæ–‡ä»¶ä¸å­˜åœ¨: {report_path}")
            return False

        # æå–æ ‡é¢˜
        first_line = md_content.split('\n')[0]
        title = first_line.replace('#', '').strip() if first_line.startswith('#') else "AI Report"

        # æ„å»ºé‚®ä»¶ä¸»é¢˜
        subject_prefix = self.config['content']['subject_prefix']
        date_str = datetime.now().strftime('%Y-%m-%d')
        report_name = "Claude Code æ—¥æŠ¥" if report_type == "ccnews" else "AI å…¨æ™¯åŠ¨æ€"
        subject = f"{subject_prefix} {report_name} - {date_str}"

        # è½¬æ¢ä¸º HTML
        if self.config['content']['format'] == 'html':
            html_content = markdown_to_html(md_content, title)
            body = html_content
            subtype = 'html'
        else:
            body = md_content
            subtype = 'plain'

        # åˆ›å»ºé‚®ä»¶
        msg = MIMEMultipart()
        msg['From'] = f"{self.sender_config['name']} <{self.sender_config['email']}>"
        msg['To'] = ', '.join(self.config['recipients'])
        msg['Subject'] = subject

        # æ·»åŠ æ­£æ–‡
        msg.attach(MIMEText(body, subtype, 'utf-8'))

        # æ·»åŠ  Markdown é™„ä»¶ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
        if self.config['content'].get('attach_markdown', False):
            attachment = MIMEBase('application', 'octet-stream')
            attachment.set_payload(md_content.encode('utf-8'))
            encoders.encode_base64(attachment)
            filename = f"{report_type}_{date_str}.md"
            attachment.add_header('Content-Disposition', f'attachment; filename={filename}')
            msg.attach(attachment)

        # å‘é€é‚®ä»¶
        try:
            logger.info(f"æ­£åœ¨è¿æ¥ SMTP æœåŠ¡å™¨: {self.smtp_config['host']}:{self.smtp_config['port']}")

            if self.smtp_config.get('use_ssl', False):
                server = smtplib.SMTP_SSL(
                    self.smtp_config['host'],
                    self.smtp_config['port'],
                    timeout=30
                )
            else:
                server = smtplib.SMTP(
                    self.smtp_config['host'],
                    self.smtp_config['port'],
                    timeout=30
                )
                if self.smtp_config.get('use_tls', True):
                    server.starttls()

            logger.info("æ­£åœ¨ç™»å½•...")
            server.login(self.sender_config['email'], self.password)

            logger.info(f"æ­£åœ¨å‘é€é‚®ä»¶åˆ°: {', '.join(self.config['recipients'])}")
            server.send_message(msg)
            server.quit()

            logger.info(f"âœ“ é‚®ä»¶å‘é€æˆåŠŸï¼ä¸»é¢˜: {subject}")
            return True

        except smtplib.SMTPAuthenticationError:
            logger.error("SMTP è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥é‚®ç®±åœ°å€å’Œå¯†ç ")
            return False
        except smtplib.SMTPException as e:
            logger.error(f"SMTP é”™è¯¯: {e}")
            return False
        except Exception as e:
            logger.error(f"å‘é€é‚®ä»¶å¤±è´¥: {e}")
            return False


# ============================================================================
# ä¸»å‡½æ•°
# ============================================================================

def main():
    parser = argparse.ArgumentParser(description='å‘é€ Mind AI æŠ¥å‘Šåˆ°é‚®ç®±')
    parser.add_argument('--report', required=True, help='æŠ¥å‘Šæ–‡ä»¶è·¯å¾„ï¼ˆå¦‚ cc/2025-10-28/index.mdï¼‰')
    parser.add_argument('--type', choices=['ccnews', 'ainews'], default='ccnews',
                        help='æŠ¥å‘Šç±»å‹')
    parser.add_argument('--config', help='é…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆé»˜è®¤: .shared/config.yamlï¼‰')

    args = parser.parse_args()

    logger.info("=" * 60)
    logger.info("Mind AI Report - é‚®ä»¶å‘é€å·¥å…·")
    logger.info("=" * 60)

    # åŠ è½½é…ç½®
    try:
        config = load_config(args.config)
    except FileNotFoundError:
        logger.error("é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥ .shared/config.yaml")
        return 1
    except yaml.YAMLError as e:
        logger.error(f"é…ç½®æ–‡ä»¶è§£æé”™è¯¯: {e}")
        return 1

    # å‘é€é‚®ä»¶
    sender = EmailSender(config)
    success = sender.send_report(args.report, args.type)

    logger.info("=" * 60)
    return 0 if success else 1


if __name__ == '__main__':
    sys.exit(main())
